<?xml version="1.0" ?>

<container xmlns="http://symfony.com/schema/dic/services"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd">

    <parameters>
		<!-- Registry -->
	    <parameter key="erato_framework.metadata.registry.class">Clio\Extra\Metadata\SchemaRegistry</parameter>
	    <parameter key="erato_framework.metadata.reference_registry.class">Erato\Adapter\SymfonyBundles\FrameworkBundle\Metadata\SchemaRegistry</parameter>
		<!--  -->
	    <parameter key="erato_framework.metadata.registry.cache_loader.class">Clio\Extra\Registry\Loader\CachedLoader</parameter>
	    <parameter key="erato_framework.metadata.registry.cache_loader.ttl">10</parameter>
	    <parameter key="erato_framework.metadata.registry.factory_loader.class">Clio\Component\Pattern\Registry\Loader\MappedFactoryLoader</parameter>
		
		<!-- -->
        <parameter key="erato_framework.metadata.class_metadata_factory.class">Erato\Core\Metadata\Factory\ClassMetadataFactory</parameter>
		<!-- Loader -->
        <parameter key="erato_framework.metadata.mapped_factory_loader.class">Clio\Component\Pattern\Registry\Loader\MappedFactoryLoader</parameter>
		<!-- Mapping Injector -->
		<parameter key="erato_framework.metadata.cache_warmer.class">Clio\Extra\Metadata\Cache\MetadataCacheWarmer</parameter>

		<parameter key="erato_framework.metadata.cache_clearer.class">Clio\Adapter\SymfonyBundles\ComponentBundle\Cache\CacheProviderClearer</parameter>

		<parameter key="erato_framework.metadata.choice_config_loader.class">Erato\Core\Metadata\Config\Loader\ChoiceLoader</parameter>
		<parameter key="erato_framework.metadata.merge_config_loader.class">Erato\Core\Metadata\Config\Loader\MergeLoader</parameter>
		<parameter key="erato_framework.metadata.annotation_config_loader.class">Erato\Bridge\DoctrineCommon\Metadata\Config\Loader\AnnotationLoader</parameter>
    </parameters>

	<services>
		<!-- Metadata Registry with Loader -->
		<service
			id="erato_framework.metadata.registry"
			class="%erato_framework.metadata.registry.class%"
		>
			<argument type="service" id="erato_framework.metadata.registry.loader"/>
			<argument type="service" id="erato_framework.type_registry"/>
			<tag name="clio_component.reference" class="%erato_framework.metadata.reference_registry.class%"/>
		</service>
		<!-- Registry Loader -->
		<!-- Registry Cache Loader -->
		<service
			id="erato_framework.metadata.registry.cache_loader"
			class="%erato_framework.metadata.registry.cache_loader.class%"
		>
			<argument type="service" id="erato_framework.metadata.registry.factory_loader"/>
			<argument type="service" id="erato_framework.metadata.registry.cache_loader.cache" on-invalid="null"/>
			<argument type="service" id="erato_framework.metadata.cache_warmer" on-invalid="null"/>
			<call method="setTtl">
				<argument>%erato_framework.metadata.registry.cache_loader.ttl%</argument>
			</call>
		</service>

		<service 
			id="erato_framework.metadata.registry.cache_loader.default_cache"
			class="Clio\Component\Util\Cache\CacheProvider" 
			public="false"
			factory-service="erato_framework.cache_factory"
			factory-method="createCacheProvider"
		>
			<argument></argument><!-- type -->
			<argument></argument><!-- arguments -->
		</service>

		<!-- Metadata Loader -->
		<service
			id="erato_framework.metadata.registry.factory_loader"
			class="%erato_framework.metadata.registry.factory_loader.class%"
		>
			<argument type="service" id="erato_framework.metadata.class_metadata_factory"/>
		</service>

		<!-- Class Factory -->
		<service
			id="erato_framework.metadata.class_metadata_factory"
			class="%erato_framework.metadata.class_metadata_factory.class%"
		>
			<argument type="service" id="erato_framework.metadata.mapping_factory"/>

			<call method="setLoader">
				<argument type="service" id="erato_framework.metadata.config_loader" on-invalid="ignore"/>
			</call>
		</service>

		<!-- Mapping Factory -->
		<service
			id="erato_framework.metadata.mapping_factory"
			alias="erato_framework.metadata.mapping_factory.collection"
		/>

		<!-- Injector -->
		<service
			id="erato_framework.metadata.mapping_injectors"
			class="Clio\Component\Util\Injection\Injector"
			factory-service="erato_framework.metadata.mapping_factory"
			factory-method="getInjector"
		>
		</service>
		<!-- Injector Invoker -->
		<service
			id="erato_framework.metadata.cache_warmer"
			class="%erato_framework.metadata.cache_warmer.class%"
		>
			<argument type="service" id="erato_framework.metadata.mapping_injectors"/>
		</service>

		<service
			id="erato_framework.metadata.cache_clearer"
			class="%erato_framework.metadata.cache_clearer.class%"
		>
			<argument type="service" id="erato_framework.metadata.registry.cache_loader.cache" on-invalid="null"/>
			<tag name="kernel.cache_clearer"/>
		</service>

		<!-- Configuration Loader -->
		<service
			id="erato_framework.metadata.default_config_loader.choice"
			class="%erato_framework.metadata.choice_config_loader.class%"
			abstract="true"
		>
		</service>
		<service
			id="erato_framework.metadata.default_config_loader.merge"
			class="%erato_framework.metadata.merge_config_loader.class%"
			abstract="true"
		>
		</service>

		<service
			id="erato_framework.metadata.default_config_loader.annotation"
			class="%erato_framework.metadata.annotation_config_loader.class%"
			abstract="true"
		>
			<argument type="service" id="annotation_reader"/>
		</service>
	</services>	
</container>
